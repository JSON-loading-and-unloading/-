# 13장 프로파일링

* 프로파일링의 가장 일반적인 접근 방식은 실행, 할당입니다.
* 프로파일링 실행은 편향이 드러난 상황에서 성능을 분석하는 분야입니다.
* 엔지니어가 자신의 인지 편향 문제를 스스로 해결하는 일 또한 중요합니다.

## 13.1 프로파일링 개요

* JVM 프로파일링/모니터링 툴은 보통 저수준의 인스트루먼테이션을 이용해서 작동하며, 수집한 데이터는 그래픽 콘솔에 피드백하거나 추후 분석 용도로 로그에 저장합니다.
* 저수준 인스트루먼테이션은 대부분 애플리케이션 시작 시 로드되는 에이전트나 실행 중인 JVM에 동적으로 부착하는 컴포넌트 형태로 구현합니다.
* 넓은 의미에서 모니터링 툴, 경고 시스템, 프로파일러를 명확히 구분해야 합니다.
* 성능 문제를 진단하고 바로잡는 첫걸음은 문제를 일으키는 리소스를 찾아내는 것입니다.

## 13.2 샘플링과 세이프포인트 편향

* 실행 프로파일링에서 기억해야 할 사실은, 실행 중인 코드의 자료점을 대부분 샘플링을 통해 획득한다는 점입니다.
* 측정하는 행위는 비용이 발생하기에 이 비용을 줄이고자 메소드 입출구는 추적하지 않고 스레드 실행 스냅샷을 찍는데, 비교적 낮은 빈도로 찍으면 오버헤드가 크지 않습니다.
* 셈플링은 문제점이 데이터에 가려지게 만들 빌미를 제공할 뿐만 아니라, 대부분의 샘플링이 세이프포인트에서만 일어난다는 점도 문제가 됩니다. 이를 세이프포인팅 편향이라고 하며, 두 중요한 결과를 수반합니다.
  * 모든 스레드는 샘플을 뜨기 전에 세이프포인트에 다다라야 합니다.
  * 세이프포인트 지점에 있는 애플리케이션 상태만 샘플링할 수 있습니다.

## 13.3 개발자용 프로파일링 툴

* VisualVM : 실행 프로파일러, 메모리 프로파일러가 모두 들어가있고 사용하기 쉬운 무료 툴입니다. 프로파일링 세계에 입문한 성능 엔지니어가 처음써보는 용도로는 훌륭합니다.
* JProfiler : GUI 모드뿐만아니라 헤드리스 모드로 로컬 또는 원격 애플리케이션을 프로파일링할 수 있습니다.
* YourKit : GUI 컴포넌트를 제공하여 에이전트를 동적으로 어태치하거나 애플리케이션 시작 시 설정하는 측면에 JProfiler와 비슷합니다.
* JFR/JMC : 오라클 JDK의 JVM용 툴 상용 버전으로 자리를 잡았습니다.
* 운영 툴 : 프로파일러는 개발자가 문제점을 진단하거나 애플리케이션이 런타임에 저수준에서 어떻게 작동하는지 파악하려고 사용하지만, 운영계 모니터링 툴로도 많이 쓰입니다.
  * 레드햇 서모스탯 : OpenJDK와 사용 라이선스가 같고 단일 머신, 클러스터 모두 모니터링할 수 있습니다. 이력 데이터와 특정 시점별 상태 정보는 몽고 DB에 저장합니다.
  * 뉴 렐릭 : 클라우드 기반 애플리케이션용 SaaS 제품입니다. JVM뿐만 아닌 사용 범위가 넓은 범용 툴 세트 입니다.
  * jClarity 일루미네이트 : 개발자 프로파일링 툴과 운영 모니터링 툴 사이의 징검다리 역할을 합니다.

## 13.4 최신 프로파일러

* 어니스트 프로파일러 : 어니스트 프로파일러는 다음과 같은 목표를 가집니다.
  * 다른 대부분의 프로파일러에 있는 세이프포인트 편향을 없앤다.
  * 오버헤드가 아주 낮은 상태로 작동시킨다.
* perf : 리눅스 애플리케이션의 경량급 프로파일링 툴입니다. 특정 자바/JVM 애플리케이션에 구애받지 않으며, 하드웨어 성능 카운터를 읽습니다.
* Async : 어니스트 프로파일러를 대체할만한 툴입니다. 어니스트 프로파일러와 같은 내부 API를 쓰며 핫스팟 JVM에서만 실행 가능한 오픈 소스 툴입니다.

## 13.5 할당 프로파일링

* 대부분의 애플리케이션은 일정 수준의 메모리 프로파일링도 병행해야 합니다.
* 할당 프로파일링은 애플리케이션의 할당 동작을 살피는 표준 메모리 프로파일링입니다.
* JVM에서 메모리 할당을 지시하는 바이트코드는 NEW, NEWARRAY, ANEWARRAY가 있습니다.
* 할당을 일으키는 옵코드는 셋뿐이라 인스트루먼테이션할 바이트코드도 이들뿐입니다.
* TLAB을 이용해 할당 프로파일링하는 방법도 있습니다.
* Async 프로파일러는 핫스팟 전용 콜백을 이용해 다음 시점에 알림을 수신하는 TLAB 샘플링 기능을 지원합니다.
  * 새로 만든 TLAB에 객체가 할당될 때
  * TLAB 밖에 객체가 할당될 때
* 객체 할당을 일일이 전부 다 세지 않고, 매 n 킬로바이트 단위로 뭉뚱그려 할당을 기록합니다.

## 13.6 힙 덤프 분석

* 힙 덤프 분석은 전체 힙의 스냅샷을 툴로 자세히 뜯어보면서 어떤 객체가 살아 있는지, 그 개수와 타입은 어떤지 등의 중요한 팩트와 객체 그래프의 형상/구조를 파악하는 일입니다.
* 힙 덤프는 크기가 문제입니다. 덤프한 메모리 크기의 3~400%에 달하는 경우도 흔합니다.
* 힙 파일 생성은 힙을 샅샅이 뒤져 덤프 파일을 쓰는 과정이므로 STW 이벤트도 불가피합니다.
* hprof : JDK 5부터 내장된 hprof 프로파일러는 제품급 프로파일러라기보다는 저음부터 JVMTI 기술의 기준 구현체로 의도된 툴입니다. 자바 9 이후로는 JDK에서 사라졌습니다.