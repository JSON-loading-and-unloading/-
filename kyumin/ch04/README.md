# 4장 : 성능 테스트 패턴 및 안티 패턴

## 4.1 성능 테스트 유형

| 종류                                | 질문 예시                            |
|-----------------------------------|----------------------------------|
| 지연 테스트(Latency test)              | 종단 트랜잭션에 걸리는 시간은?                |
| 처리율 테스트(Throughput test)          | 현재 시스템이 처리 가능한 동시 트랜잭션 개수는?      |
| 부하 테스트(Load test)                 | 특정 부하를 시스템이 감당할 수 있는가?           |
| 스트레스 테스트(Stress test)             | 이 시스템의 한계점은 어디까지인가?              |
| 내구성 테스트(Endurance test)           | 시스템을 장시간 실행할 경우 성능 이상 증상이 나타나는가? |
| 용량 계획 테스트(Capacity planning test) | 리소스를 추가한 만큼 시스템이 확장되는가?          |
| 저하 테스트(Degradation)               | 시스템이 부분적으로 실패할 경우 어떤 일이 벌어지나?    |

### 4.1.1 지연 테스트

* 지연 테스트는 가장 일반적인 성능 테스트입니다.
* 지연 테스트의 목적이 너무 정량적이고 명확하여 다른 종류의 성능 테스트의 이유를 흐리게 만들수 있는 양날의 검입니다.
* 단순 평균값은 애플리케이션의 요청 응답성을 측정하는 지표로 별로 소용이 없다는 사실도 주의해야 합니다.
* 지연 테스트를 수행하는 동안 진행 중인 동시 트랜잭션을 명시해야 합니다.

### 4.1.2 처리율 테스트

* 처리율 테스트는 지연 테스트 다음으로 일반적인 성능 테스트입니다.
* 처리율 테스트의 목적은 시스템 성능이 급락하기 직전, 최대 처리율 수치를 측정하는 것입니다.
* 처리율은 지연과 동등한 개념이라고 볼 수 있습니다.
* 처리율은 지연을 모니터링하면서 테스트합니다.

### 4.1.3 부하 테스트

* 부하 테스트는 처리율 테스트와는 조금 다릅니다. 목표 수준의 부하에 대해 시스템이 견딜 수 있는지 답을 구하는 과정입니다.
* 애플리케이션 트래픽이 상당할 것으로 예상되는 특정 비지니스 이벤트에 대비하기위해 수행합니다.

### 4.1.4 스트레스 테스트

* 스트레스 테스트는 시스템 여력이 어느 정도인지 알아보는 수단입니다.
* 특정 처리율을 시스템에 계속 걸어둔 상태에서 시간이 갈수록 서서히 동시 트랜잭션이 증가하고 시스템 성능이 저하됩니다. 저하되기 직전 값이 최대 처리율입니다.

### 4.1.5 내구 테스트

* 내구 테스트를 통해 메모리 누수, 캐시 오염, 메모리 단편화 등의 문제를 감지합니다.
* 평균 사용률로 시스템에 일정 부하를 계속 주며 모니터링하다가 갑자기 리소스가 고갈되거나 시스템이 깨지는 지점을 찾습니다.

### 4.1.6 용량 계획 테스트

* 용량 계획 테스트는 업그레이드한 시스템이 어느 정도 부하를 감당할 수 있을지 미리 내다보는 것입니다.
* 예정된 계획의 일부분으로 실행하는 경우가 많습니다.

### 4.1.7 저하 테스트

* 저하 테스트는 부분 실패 테스트라고도 합니다.
* 저하 테스트 도중 눈여겨 봐야할 측정값은 트랜잭션 지연 분포와 처리율입니다.
* 부분 실패 테스트 중에는 카오스 멍키라는 하위 유형이 있습니다.
  * 카오스 멍키의 요지는, 진짜 복원성 있는 아키텍처는 여러 컴포넌트중 하나의 컴포넌트가 잘못돼도 다른 컴포넌트에 부정적인 영향이 없어야한다라는 것입니다.

## 4.2 기본 베스트 프랙티스

성능 튜닝 시 주안점을 두어야할 부분은 다음의 원칙에 따라 결정합니다.

* 나의 관심사가 무엇인지 식별하고 그 측정 방법을 고민한다.
* 최적화하기 용이한 부분이 아니라, 중요한 부분을 최적화한다.
* 중요한 관심사를 먼저 다룬다.

### 4.2.1 하향식 성능

* 전체 애플리케이션의 성능 양상부터 먼저 알아보는 접근 방식을 하양식 성능이라고 합니다.
* 하향식 성능 접근 방식으로 성과를 극대화하려면, 먼저 테스트 환경을 구축한후에, 무엇을 측정할지 최적화해야할지 결정하고, 성능 활동을 전체 소프트웨어 개발 주기에 어떻게 병행해야 하는지, 마지막으로 전 팀원이 명확하게 이해해야 합니다.

### 4.2.2 테스트 환경 구축

* 테스트 환경은 가급적 모든 면에서 운영 환경과 똑같이 복제해야 합니다.
* 운영 환경과 많이 차이나는 성능 테스트 환경에서는 실제 환경에서 어떤 일들이 일어날지 예측하기 어렵고 쓸모있는 결과를 얻지 못할 가능성이 큽니다.

### 4.2.3 성능 요건 식별

* 성능 평가하는 지표는 코드뿐만아닌 시스템 전체적으로 바라보며 고객과 경영진에게 중요한 측정값을 고려해야 합니다. 이렇게 최적화하려는 핵심 지표를 성능 비기능 요건이라고 합니다.

### 4.2.4 자바의 특정 이슈

* JVM은 성능 엔지니어가 잘 이해하고 주의 깊게 살펴야 할 복잡 미묘한 부분들이 있습니다. JVM 특유의 다이내믹한 자기 관리 기능이 추가되면서 복잡해졌기 때문입니다.

### 4.2.5 SDLC 일부로 성능 테스트 수행하기

* 성능 테스트는 SDLC(소프트웨어 개발 수명주기)의 일부로서 수행하며, 성능 회귀 테스트를 상시 수행하면 좋습니다.

## 4.3 성능 안티패턴 개요

안티패턴은 사람들이 수많은 프로젝트를 수행하면서 밝혀낸, 소프트웨어 프로젝트 또는 팀의 좋지 않은 패턴입니다.

성능 튜닝은 항상 초기 기획 단계부터 구체적으로 목표를 정해놓고 시작하는 목표 지향형 프로세스로 접근해야 합니다.

다음은 개발자가 잘못된 기술 선택을 밥 먹듯이 하나에 대해 다섯 가지 이유를 정리했습니다.

### 4.3.1 지루함

 개발자는 대부분 자기 역할에 지루함을 느끼고 뭔가 새롭고 도전적인 일을 찾지만 이러한 지루함은 프로젝트에 여러 가지 해악을 끼칠 수 있습니다.

 예로는 지금껏 알려지지 않은 기술로 컴포넌트를 제작하거나, 맞지도 않은 유스케이스에 억지로 기술을 욱여넣는 등이 있습니다.

### 4.3.2 이력서 부풀리기

 자신의 이력서를 과대 포장할 구실을 찾는 개발자도 있습니다. 이를 통해 불필요한 기술을 덧댄 결과는 아주 오랫동안 시스템에 지대한 영향을 미치게 됩니다.

### 4.3.3 또래 압박

팀원들이 기술을 결정할 때 관심사를 분명히 밝히지 않고, 서로 충분한 논의 없이 진행하면 쓰디쓴 결과를 맛보기 쉽습니다.

### 4.3.4 이해 부족

 지금 사용하는 툴의 기능도 온전히 알지 못하는데 무턱대고 새로운 툴로 문제를 해결하려는 개발자가 있습니다. 하지만 기술 복잡도를 높이는 것과 현재 툴로도 할 수 있는 것 사이의 균형을 잘 맞추어야 합니다.

### 4.3.5 오해와 있지도 않은 문제

 문제 자체가 무엇인지 제대로 이해하지 못한 채 오로지 기술을 이용해서 문제를 해결하려는 개발자도 있습니다.

성능 지표를 수집/분석해야만 비로소 문제의 본질을 정확히 이해할 수 있습니다.

안티 패턴을 예방하려면 팀원 모두 참여해서 기술 이슈를 활발히 공유하는 분위기를 적극 장려해야 합니다.

## 4.4 성능 안티패턴 카탈로그

### 4.4.1 화려함에 사로잡히다

증상 : 일단 최신의 멋진 시술을 튜닝 타깃으로 정합니다.

현실 : 실 상황에서 맞지 않을 가능성이 높으며, 다른 문제가 불거질 수도 있습니다.

처방 : 실제 측정을 통한 병목점 탐색과 새 컴포넌트에 대해 충분한 로그를 남겨야합니다. 또한 베스트 프랙티스 및 단순화한 데모를 참조하여 마지막으로 팀원들간의 새 기술의 공유를 활성화해야 합니다.

### 4.4.2 단순함에 사로잡히다

증상 : 전체적으로 애플리케이션을 프로파일링하여 객관적으로 아픈 부분을 들추려하지 않고 무작정 시스템에서 제일 간단한 부분만 파고듭니다.

현실 : 원개발자는 그 시스템 파트를 어떻게 튜닝해야 할지 압니다. 또한 다양한 시스템 컴포넌트에 대한 지식 공유를 하지 않아 독보적인 전문가만 양산됩니다.

처방 : 측정을 통한 병목점 탐색과 전문가의 도움을 통해 개발자가 전체 시스템 컴포넌트를 고루 이해하도록 독려해야합니다.

### 4.4.3 성능 튜닝 도사

증상 : 외부의 성능 튜닝 전문가에게 일을 맡깁니다.

처방 : 측정을 통한 병목점 탐색과 새로 채용된 팀내 전문가가 다른 팀원들간의 지식 공유가 활성화될 수 있도록 리드해야합니다.

### 4.4.4 민간 튜닝

증상 : 검증되지 않은 방법을 무작정 도입하려 합니다.

현실 : 어떤 영향을 미칠지 모르며, 특정 시스템에서만 효용이 있을 수 있으며 오히려 성능이 더 안좋아질 수 있습니다.

처방 : 시스템의 가장 중요한 부분에 직접 영향을 미치는 기술을 확실히 파악하고 충분히 검증된 것들만 적용해야합니다. 또한 다른 개발자나 운영 요원, 데브옵스팀과 함께 설정 문제를 리뷰하고 토의해야합니다.

### 4.4.5 안되면 조상 탓

증상 : 정작 이슈와는 아무 상관 없는 특정 컴포넌트를 문제 삼습니다.

현실 : 충분하지 못한 분석을 통해 성급한 결론을 내립니다. 또한 숲을 보려는 노력을 하지 않습니다.

처방 : 성급한 결론을 내리면 안됩니다. 정상적을 분석하며, 분석 결과를 모든 이해관계자와 의논해야합니다.

### 4.4.6 숲을 못 보고 나무만 보다

증상 : 전체적인 변경 영향도를 완전히 파악하지 않은 채 일단 그냥 변경을 해보거나 애플리케이션의 국소적인 부분만 프로파일링합니다.

현실 : 변경 영향도를 완전히 이해한 사람은 없습니다. 새로 바꾼 JVM 설정값 하에서 애플리케이션을 완전히 프로파일링하지 않습니다.

처방 : 운영계에서 스위치를 변경하기 전 다음절차를 따라야합니다.

    1. 운영계 성능 지표를 측정합니다.
    2. UAT에서 한번에 스위치 하나씩 변경합니다.
    3. 스트레스를 받는 지점이 UAT와 운영계가 동일한지 확인합니다.
    4. 운영계에서 일반적인 부하를 나타내는 테스트 데이터를 확보합니다.
    5. UAT에서 스위치를 변경하며 테스트합니다.
    6. UAT에서 다시 테스트합니다.
    7. 여러분이 추론한 내용을 다른 사람에게 재검토 요청합니다.
    8. 여러분이 내린 결론을 다른 사람과 공유합니다.

### 4.4.7 내 데스크톱이 UAT

증상 : UAT 환경이 운영계 환경과 전혀 다른 경우가 많지만, 개발자는 그 차이점을 예상하거나 완전히 이해하지 못한 채 저성능 데스크톱에서 고성능 운영 서버로 서비스할 코드를 작성합니다.

현실 : UAT 환경이 운영계와 달라 서비스가 중단되는 사태가 벌어지면 장비 추가 비용보다 더 값비싼 대가를 치르게 됩니다.

처방 : 서비스 중단 비용과 고객 이탈로 인한 기회비용을 잘 따져봐야합니다. 또한 운영 환경과 동일한 UAT 환경을 구입해야합니다.

### 4.4.8 운영 데이터처럼 만들기는 어려워

증상 : 데이터라이트라고도 하는 이 안티패턴은, 사람들이 운영계와 유사한 데이터를 나타내고자 할 때 빠지는 함정입니다.

현실 : UAT에서 정확한 결과를 얻으려면 운영계 데이터와 최대한 맞추어야 합니다.

처방 : 데이터 도메인 전문가에게 컨설팅을 받고 운영 데이터를 UAT로 다시 이전하는 프로세르를 구축해야합니다. 또한 트래픽이 몰릴거라 예상되는 서비스는 출시 전 철저히 준비해야합니다.

### 4.5 인지 편향과 성능 테스트

인간은 원래 정확하고 신속하게 의견을 정리하는 일에 서투릅니다.

> 인지 편향 : 인간의 두뇌가 부정확한 결론을 내리게 이끄는 심리 작용입니다. 편향을 보이는 사람이 대개 자신이 그런 줄도 모르고 스스로는 아주 이성적이라고 믿는 게 더 큰 문제입니다.

앞에서 살펴본 안티패턴도 대부분, 전체/부분적으로는 하나 이상의 인지 편향에서 비롯된것입니다. 즉, 무의식중에 어떤 가정을 내리는 것입니다.

각 편향은 이중적 또는 상보적입니다.

### 4.5.1 환원주의

 환원주의는 시스테을 아주 작은 조각으로 나누어 그 구성 파트를 이해하면 전체 시스템도 다 이해할 수 있다는 분석주의적 사고방식입니다. 각 파트를 이해하면 그릇된 가정을 내릴 가능성도 작을 거라는 편향된 논리입니다.

하지만 복잡한 시스템에서는 전체적인 관점에서 봐야 문제의 원인을 찾을 수 있습니다.

### 4.5.2 확증 편향

확증 편향은 성능 면에서 중대한 문제를 초래하거나, 애플리케이션을 주관적으로 바라보게 합니다. 확증 편향은 보통 강력한 동기가 부여되거나 감정 요소가 개입되기 때문에 거스르기가 어렵습니다.

### 4.5.3 전운의 그림자(행동 편향)

시스템이 예상대로 작동하지 않는 상황, 또는 아예 중단된 시간 중에 발현되는 편향입니다. 다음은 원인들중 흔한 것들입니다.

* 영향도를 분석해보지도 않고, 또 다른 사람에게 연락도 안 하고 시스템 인프라를 변경합니다.
* 시스템이 의존하는 라이브러리를 변경합니다.
* 연중 가장 업무가 빠듯한 날에 처음 보는 버그나 경합 조건이 발생합니다.

### 4.5.4 위험 편향

인간의 본성은 위험을 피하고 변화를 거부합니다. 단위 테스트 세트와 운영계 회귀 테스트 체계만 확실히 갖춘다면 리스크를 상당히 줄일 수 있습니다. 

위험 편향은 보통 애플리케이션 문제가 생겼을 때 제대로 학습하고 적절한 조치를 하지 못한 까닭에 더 고착화 됩니다.

### 4.5.5 엘스버그 역설

엘스버그 역설은 인간이 확률을 이애하는 데 얼마나 서투른지 잘 보여주는 사례입니다.

엘스버그는 알려지지 않은 미지의 것보다 알려진 기지의 것을 추구하는 인간 본연의 욕구에 관한 역설을 주장했습니다.

## 4.6 마치며

성능 결과를 평가할 때에는 데이터를 적절한 방법으로 처리하고 비과학적인, 주관적인 사고에 빠지지 않도록 조심해야 합니다.