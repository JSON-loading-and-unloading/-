<h1>GC 로깅, 모니터링, 튜닝, 툴</h1><br>

<h2>GC 로깅 개요</h2>

모든 중요한 애플리케이션에서 설정해야할 두 가지!!<br>
1. GC로그를 생성
2. 애플리케이션 출력과는 별도로 특정 파일에 GC로그를 보관한다.
   =>GC로깅은 오버헤드가 거의 없는 것으므로 항상 로깅을 켜놓는다.<br>


![KakaoTalk_20230819_150717023](https://github.com/JSON-loading-and-unloading/Optimizing-Java/assets/106163272/799ce70e-6857-4454-a1ca-3d16ac49c417)


   

<h4>GC 로깅 켜기</h4>
   플래그 주의사항<br>
   - 기존 플래그 verbose:gc는 지우고 대신 printGCDetails를 사용한다.<br>
   - PrintTenuringDistributiondms 다소 독특한 플래그로, 이 플래그가 제공하는 정보를 사람이 이용하기는 어렵다. 중요한 메모리압 효과, 조기 승격 등의 이벤트 계산 시 필요한 기초 데이터를 제공한다.
   - PrintGCDateStamps와 PrintGCTimeStamps는 둘 다 필요하다. 전자는 GC 이벤트와 애플리케이션 이벤트를, 후자는 GC와 다른 내부 JVM 이벤트를 각각 연관짓는 용도로 쓰인다.

![KakaoTalk_20230819_150717023_01](https://github.com/JSON-loading-and-unloading/Optimizing-Java/assets/106163272/cf436a93-0126-45d5-9401-af64a7ab9cab)


로그 순환 정책은 운영팀과 협의해서 합리적으로 수립해야 한다.


<h4>GC 로그 vs JMX</h4>

- GC 로그 데이터는 실제 가비지 수집 이벤트가 발생해 쌓이지만, JMX는 데이터를 샘플링하여 얻는다.
- GC 로그 데이터는 캡쳐 영향도가 거의 없으나, JMX는 프록시 및 원격 메소드 호출(Remote Method Invocation) 과정에서 비용이 발생한다.
- GC 로그 데이터는 자바 메모리 관리에 연관된 성능 데이터가 50가지 이상이지만, JMX는 10가지도 안된다.
- JMX는 스트리밍된 데이터를 즉시 제공하지만 위와 같은 이유에서 GC 로그가 성능 관점에서 조금 더 좋아보일 수 있다. 추가로 요즘은 jClarity 센섬같은 툴도 GC 로그 데이터를 스트리밍하는 API를 제공하므로 큰 차이는 없다.

- <h4>JMX의 단점</h4>

- JMX를 이용해 애플리케이션을 모니터링하는 클라이언트는 대부분 런타임을 샘플링해 현재 상태를 업데이트 한다. 클라이언트는 데이터를 계속 넘겨받기 위해 런타임에있는 JMX 빈을 폴링한다. 문제는 GC가 언제 실행될지 클라이언트는 알 수 없으므로, GC 전후의 메모리 상태 역시 알 수 없으며 따라서 GC 데이터를 깊이있게 정확히 분석하기 힘들다.
- JMXConnector를 구현한 코드는 내부적으로 RMI에 의존하는데, RMI기반 통신은 방화벽에 포트를 열어야하므로 secondary socket connection이 발생하며, 프록시 객체를 이용해 remove() 메소드 호출을 대행하고 Java finalization에 의존한다는 고질적인 문제점이 존재한다. 
- 접속을 해제하는 작업은 finalize에 의존하는데 이는 GC를 돌려 객체를 회수해야하므로 종료화가 GC에 미치는 영향을 고려하지 않을 수 없다.
- RMI를 사용하는 애플리케이션은 기본 1시간에 한번씩 full GC가 발생하는데, JMX를 사용하는 순간부터 추가적인 부하는 피할수 없을 것이다.
<br>
RMI : 분산되어 존재하는 객체 간의 메시지 전송(메소드를 호출하는 것 포함)을 가능하게 하는 프로토콜.<br>
JMS : Java EE 를 기반으로 하는 애플리케이션 컴포넌트가 메시지를 작성, 전송, 수신 및 읽을 수 있도록 하는 API.<br>


<h2>로그 파싱 툴</h2>

<h3>센섬</h3>

- jClarity사가 제작한 상용 메모리 분석기이다.
- 데스크톱 툴로 써도 되고 서비스 모니터링 용도로도 사용할 수 있다.
- 센섬은 최고의 GC 로그 파싱, 정보 추출, 자동 분석 기능을 제공하는 것이 목표이다.

  센섬 최신 버전이 지원하는 자동 분석 기능<br>
  - 정확한 할당률
  - 조기 승격
  - 공격적인 할당
  - 유저 이탈
  - 메모리 누수 감지
  - 힙 크기 조정 및 용량 계획
  - vm에 대한 os 간섭
  - 크기를 잘못 잡은 메모리 풀

<h3>GCViewer</h3>

- GCViewer는 GC 로그 파싱 및 그래프 출력 등 기본 기능을 갖춘 데스크톱 툴이다.
- GCViewer는 분석 기능은 없고 특정 GC 핫스팟 로그 포맷만 파싱할 수 있다.
- GCViewer를 파싱 라이브러리로 쓰고 결과 데이터를 시각화 툴로 내보내는 방법도 있지만, 기존 오픈 소스 코드 베이스에 추가 개발을 해야 하는 부담이 있다.
