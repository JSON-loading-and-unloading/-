<h2>JITWatch</h2>
오픈 소스 자바FX 툴</br>
JITWatch가 하는 일은, 실행 중인 자바 애플리케이션이 생성한 핫스팟 컴파일 상세 로그를 파싱/분석하여 그 결과를 자바FX GUI 형태로 보여주는 것이다.</br>

```
-XX:+UnlockDiagnosticVMOptions -XX:+TraceClassLoading -XX:+LogCompppliation
```
사용 시 켜야할 스위치
</br>
JITWatch는 실행시킨 프로그램에서 로그를 적재하는 일뿐만 아니라, jit작동을 시험해볼 수 있는 샌드박스라는 환경을 제공한다.</br>
샌드박스를 이용하면 작은 프로그램을 신속히 프로토타이핑하여 jvm이 어떤 jit결정을 내렸는지 확인할 수 있다.</br>

또한, 샌드박스 워크플로를 이용하면 로그파일 대신, 자바/jvm을 지원하는 언어로 작성된 프로그램을 생성하거나 로드할 수 있다.
또한, 샌드박스는 jit 서브 시스템을 조정하는 vm 스위치를 시험해볼 수 있는 환경을 제공한다.
예를 들어, 샌드박스 설정 값으로 JVM JIT 로직을 다음과 같이 변경할 수 있다.
   - 역어셈블된 네이티브 메서드를 출력하고 어셈블리 구문을 선택한다.
   - jvm에서 단계별 컴파일에 맞게 설정된 디폴트를 오버라이드한다.
   - 압축 oop 사용을 오버라이드한다.
   - OSP을 해제한다.
   - 인라이닝 디폴트 한계치를 오버라이드한다.

샌드박스가 일반 jvm 애플리케이션 실행과 다른 점은, 풀 사이즈 애플리케이션에서 jvm이 단지 샌드박스 한 조각이 아닌, 훨씬 광범위한 코드를 대상으로 최적화를 조합할 수 있다는 것이다.
=> jit 컴파일러는 단순 인라이닝만 수행하는 샌드박스에서 실행한 토이 애플리케ㅔ이션과, 진짜 인라이닝을 수행하는 실제 애플리케이션에 있는 메서드를 전혀 다르게 취급한다.
=> JITWatch는 3단뷰라는 다재다능한 뷰를 메인으로 제공한다.


자바9부터는 분할 코드 캐시가 새로 생겨서 네이티브 코드 유형마다 별도의 영역에 저장할 수 있다.
덕분에 단편화 및 스위퍼 시간을 단축하고 풀 컴파일드 코드의 지역성을 높일 수 있게됐다.

<h2>JIT 컴파일 개요</h2>

핫스팟은 프로파일 기반 최적화(PGO)를 이용해 JIT 컴파일 여부를 판단한다.</br>
내부적으로는 핫스팟 실행 프로그램 정보를 메서드 데이터 객체(MDO)라는 구조체에 저장한다.</br>
MDO의 역할 : 바이트 코드 인터프리터와 c1 컴파일러에서 jit 컴파일러가 언제, 무슨 최적화를 할지 결정하는 데 필요한 정보를 기록하는 것이다.</br>
(어떤 메서드가 호출됐고, 어느 분기문으로 갈라졌는지, 또 호출부에서는 무슨 타입이었는지 등의 정보가 담겨있다.)</br>

컴파일의 시작</br>
1. 프로파일링된 프로퍼티의 '사용 빈도'를 카운터에 계속 기록하고 그렇게 기록한 값들은 프로파일링을 거치면서 차츰 사라진다. 이로 컴파일 큐 맨 앞에 이르렀을 때도 아직 핫한 메서드만 컴파일된다.
2. 프로파일링 데이터가 모이고 컴파일 결정을 내린 후에ㅔ 컴파일러별 세부 처리 절차로 넘어간다.
3. 컴파일러는 컴파일할 코드의 내부 표현형을 빌드한다.
4. 컴파일러는 이 내부 표현형을 토대로 코드를 컴파일한다.
   핫스팟 jit 컴파일러는 다양한 최신 컴파일 최적화 기법을 총 동원</br>
    - 인라이닝
    - 루프 펼치기
    - 탈출 분석
    - 락 생략/확장
    - 단일형 디스패치
    - 인트린직
    - 온-스택 치환
5. 컴파일 c1은 추측성 최적화를 안한다. 따라서 실행 성격이 어떨지 확실하지 않은 가정하에 최적화를 하지 않는다.
6. c2는 런타임 실행을 주시한 결과를 토대로 추정을 하고 그에 따른 최적화를 수행


   실제로 돌려보면 미리 추정한 것과 엉뚱하게ㅔ 츨러가 무용지물되는 경우도 있다.</br>
   => 추측성을 최적화를 하기 전에 항상 가드라는 타당성 검사를 함.</br>
   가드는 앞서 추정한 내용이 여전히 유효한지 최적화된 코드를 실행할 때마다 확인한다.</br></br>

가드마저 실패하면 더 이상 컴파일드 코드는 안전하지 않으므로 제거한다.</br>
※핫스팟은 혹여 부정확한 코드가 실행되는 불상사를 막기 위해 즉시 해당 메ㅔ서드를 인터프리티드 모드로 강등시켜 역최적화한다.</br>
